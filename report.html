<!-- Updated report.html -->
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport de Ventes - CHNDLM S.A - Pharma</title>
    <link rel="stylesheet" href="css/dashstyle.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.21/jspdf.plugin.autotable.min.js" defer></script>
</head>

<body>
    <header>
        <h1>Rapport de Ventes - CHNDLM S.A - Pharma</h1>
        <div class="header-buttons">
            <a href="dashboard.html" id="sales-button" class="header-btn"> Tableau de bord</a>
            <a href="jesyon.html" id="sales-button" class="header-btn">Gestion des Ventes</a>
            <a href="estimation.html" id="sales-button" class="header-btn">Estimation totale des stocks</a>
            <a href="perime.html" id="sales-button" class="header-btn">Médicaments Périmés</a>
            <a href="notif.html" id="sales-button" class="header-btn">Quantités insuffisantes</a>
            <a href="report.html" id="sales-button" class="header-btn">Rapports de ventes</a>
            <a href="index.html" id="logout-button" class="logout-btn">Déconnexion</a>
        </div>
    </header>

    <section id="sales-report-section">
        <div class="filter-section">
            <label for="start-date">Période (de) :</label>
            <input type="date" id="start-date" name="start-date">

            <label for="end-date">Période (à) :</label>
            <input type="date" id="end-date" name="end-date">

            <label for="sales-filter">Type de vente :</label>
            <select id="sales-filter" name="sales-filter">
                <option value="">Tous</option>
                <option value="high">Ventes élevées</option>
                <option value="medium">Ventes moyennes</option>
                <option value="low">Ventes faibles</option>
            </select>

            <button id="filter-button" class="header-btn">Appliquer les filtres</button>
            <button id="download-pdf" class="header-btn">Télécharger le Rapport PDF</button>
        </div>

        <div id="total-sales" class="total-sales-container">
            <p>Total des ventes pour la période : <span id="total-amount" class="total-amount">0</span> GDES</p>
        </div>

        <table id="sales-report-table" class="sales-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Client</th>
                    <th>Médicament</th>
                    <th>Quantité</th>
                    <th>Prix Unitaire (GDES)</th>
                    <th>Prix Total (GDES)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const salesHistory = JSON.parse(localStorage.getItem('salesHistory')) || [];

            const salesTableBody = document.querySelector('#sales-report-table tbody');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const salesFilter = document.getElementById('sales-filter');
            const totalAmountElement = document.getElementById('total-amount');

            const renderTable = (data) => {
                salesTableBody.innerHTML = '';
                let totalSales = 0;

                if (data.length === 0) {
                    salesTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune donnée disponible</td></tr>';
                    totalAmountElement.textContent = '0';
                    return;
                }

                data.forEach((sale) => {
                    const totalSalePrice = sale.quantity * sale.price;
                    totalSales += totalSalePrice;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${sale.date}</td>
                        <td>${sale.clientName}</td>
                        <td>${sale.medication}</td>
                        <td>${sale.quantity}</td>
                        <td>${sale.price}</td>
                        <td>${totalSalePrice.toFixed(2)}</td>
                    `;
                    salesTableBody.appendChild(row);
                });

                // Add total period last line
                const totalRow = document.createElement('tr');
                const totalPrice = salesHistory.reduce((acc, sale) => (sale.price * sale.quantity)+ acc, 0)
                totalRow.innerHTML = `
                <tr>
                    <td colspan='5'><strong>Total</strong></td>
                    <td>${totalPrice.toFixed(2)}</td>
                </tr>
                `
                salesTableBody.appendChild(totalRow)

                totalAmountElement.textContent = totalSales.toFixed(2);
            };

            const filterSales = () => {
                const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
                const endDate = endDateInput.value ? new Date(endDateInput.value) : null;
                const filter = salesFilter.value;

                const filteredSales = salesHistory.filter((sale) => {
                    const saleDate = new Date(sale.date);
                    const withinDateRange =
                        (!startDate || saleDate >= startDate) &&
                        (!endDate || saleDate <= endDate);

                    if (!withinDateRange) return false;

                    if (filter === 'high') {
                        return sale.quantity > 50;
                    } else if (filter === 'medium') {
                        return sale.quantity > 20 && sale.quantity <= 50;
                    } else if (filter === 'low') {
                        return sale.quantity <= 20;
                    }

                    return true;
                });

                renderTable(filteredSales);
            };

            const downloadPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(16);
                doc.text('CENTRE HOSPITALIER NOTRE DAME DE LA MERCI S.A - Pharma', 105, 20, null, null, 'center');
                doc.setFontSize(10);
                doc.text('Adresse : 5, Rue Rivière en face du Rectorat de l\'UEH', 105, 30, null, null, 'center');
                doc.text('Email: pharmachndlm@gmail.com', 105, 35, null, null, 'center');
                doc.text('Téléphone: +509 2910-3131', 105, 40, null, null, 'center');

                doc.setLineWidth(0.5);
                doc.line(10, 45, 200, 45);

                doc.setFontSize(16);
                doc.text('Rapport de Ventes - CHNDLM S.A - Pharma', 105, 55, { align: 'center' });

                doc.setFontSize(12);
                doc.text(`Date: ${new Date().toLocaleString()}`, 105, 65, { align: 'center' });

                const startDate = startDateInput.value ? new Date(startDateInput.value).toLocaleDateString() : 'Non spécifiée';
                const endDate = endDateInput.value ? new Date(endDateInput.value).toLocaleDateString() : 'Non spécifiée';
                const filter = salesFilter.options[salesFilter.selectedIndex].text;

                doc.text(`Période: ${startDate} - ${endDate}`, 105, 75, { align: 'center' });
                doc.text(`Filtre: ${filter}`, 105, 85, { align: 'center' });

                doc.autoTable({
                    html: '#sales-report-table',
                    startY: 90,
                    theme: 'striped',
                    headStyles: { fillColor: [60, 141, 188] },
                });

                doc.save('rapport_de_ventes.pdf');
            };

            document.getElementById('filter-button').addEventListener('click', filterSales);
            document.getElementById('download-pdf').addEventListener('click', downloadPDF);

            // Initial render with all data
            renderTable(salesHistory);
        });
    </script>
</body>

</html>
