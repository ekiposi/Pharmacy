<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport de Ventes - CHNDLM S.A - Pharma</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link href="https://fonts.cdnfonts.com/css/lexend-deca" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.21/jspdf.plugin.autotable.min.js" defer></script>
    <link rel="stylesheet" href="css/dashstyle.css">
   <style>
        body {
            font-family: 'Lexend Deca', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-100">
    <header class="bg-green-200 text-black p-6 shadow-lg">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-3xl font-bold mb-4 md:mb-0">Rapport de Ventes - CHNDLM S.A - Pharma</h1>
            <nav class="flex space-x-4">
                <a href="dashboard.html" class="text-lg hover:text-green-600">Tableau de bord</a>
                <a href="jesyon.html" class="text-lg hover:text-green-600">Gestion des Ventes</a>
                <a href="estimation.html" class="text-lg hover:text-green-600">Estimation totale des stocks</a>
                <a href="perime.html" class="text-lg hover:text-green-600">Médicaments Périmés</a>
                <a href="notif.html" class="text-lg hover:text-green-600">Quantités insuffisantes</a>
                <a href="report.html" class="text-lg hover:text-green-600">Rapports de ventes</a>
                <a href="index.html" class="text-lg text-red-600 hover:text-red-800">Déconnexion</a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto mt-10">
        <section id="sales-report-section" class="p-6 bg-white rounded-lg shadow-md">
            <div class="filter-section mb-6 flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6">
                <div>
                    <label for="start-date" class="block text-sm font-medium text-gray-700">Période (de) :</label>
                    <input type="date" id="start-date" name="start-date" class="mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
                <div>
                    <label for="end-date" class="block text-sm font-medium text-gray-700">Période (à) :</label>
                    <input type="date" id="end-date" name="end-date" class="mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
                <div>
                    <label for="sales-filter" class="block text-sm font-medium text-gray-700">Type de vente :</label>
                    <select id="sales-filter" name="sales-filter" class="mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                        <option value="">Tous</option>
                        <option value="high">Ventes élevées</option>
                        <option value="medium">Ventes moyennes</option>
                        <option value="low">Ventes faibles</option>
                    </select>
                </div>
                <button id="filter-button" class="bg-green-400 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-md">Appliquer les filtres</button>
                <button id="download-pdf" class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-md">Télécharger le Rapport PDF</button>
            </div>

            <div id="total-sales" class="total-sales-container mb-6 p-4 bg-gray-100 rounded-lg">
                <p class="text-lg font-bold">Total des ventes pour la période : <span id="total-amount" class="text-green-600">0</span> GDES</p>
            </div>

            <table id="sales-report-table" class="min-w-full bg-white">
                <thead>
                    <tr class="bg-green-300 text-black">
                        <th class="py-3 px-6 text-center border-b border-gray-300">Date</th>
                        <th class="py-3 px-6 text-center border-b border-gray-300">Client</th>
                        <th class="py-3 px-6 text-center border-b border-gray-300">Médicament</th>
                        <th class="py-3 px-6 text-center border-b border-gray-300">Quantité</th>
                        <th class="py-3 px-6 text-center border-b border-gray-300">Prix Unitaire (GDES)</th>
                        <th class="py-3 px-6 text-center border-b border-gray-300">Prix Total (GDES)</th>
                    </tr>
                </thead>
                <tbody class="text-black">
                </tbody>
            </table>
        </section>
    </main>
</body>

</html>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const salesHistory = JSON.parse(localStorage.getItem('salesHistory')) || [];

            const salesTableBody = document.querySelector('#sales-report-table tbody');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const salesFilter = document.getElementById('sales-filter');
            const totalAmountElement = document.getElementById('total-amount');

            const renderTable = (data) => {
                salesTableBody.innerHTML = '';
                let totalSales = 0;

                if (data.length === 0) {
                    salesTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune donnée disponible</td></tr>';
                    totalAmountElement.textContent = '0';
                    return;
                }

                data.forEach((sale) => {
                    const totalSalePrice = sale.quantity * sale.price;
                    totalSales += totalSalePrice;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${sale.date}</td>
                        <td>${sale.clientName}</td>
                        <td>${sale.medication}</td>
                        <td>${sale.quantity}</td>
                        <td>${sale.price}</td>
                        <td>${totalSalePrice.toFixed(2)}</td>
                    `;
                    salesTableBody.appendChild(row);
                });

                // Add total period last line
                const totalRow = document.createElement('tr');
                const totalPrice = salesHistory.reduce((acc, sale) => (sale.price * sale.quantity)+ acc, 0)
                totalRow.innerHTML = `
                <tr>
                    <td colspan='5'><strong>Total</strong></td>
                    <td>${totalPrice.toFixed(2)}</td>
                </tr>
                `
                salesTableBody.appendChild(totalRow)

                totalAmountElement.textContent = totalSales.toFixed(2);
            };

            const filterSales = () => {
                const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
                const endDate = endDateInput.value ? new Date(endDateInput.value) : null;
                const filter = salesFilter.value;

                const filteredSales = salesHistory.filter((sale) => {
                    const saleDate = new Date(sale.date);
                    const withinDateRange =
                        (!startDate || saleDate >= startDate) &&
                        (!endDate || saleDate <= endDate);

                    if (!withinDateRange) return false;

                    if (filter === 'high') {
                        return sale.quantity > 50;
                    } else if (filter === 'medium') {
                        return sale.quantity > 20 && sale.quantity <= 50;
                    } else if (filter === 'low') {
                        return sale.quantity <= 20;
                    }

                    return true;
                });

                renderTable(filteredSales);
            };

            const downloadPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(16);
                doc.text('CENTRE HOSPITALIER NOTRE DAME DE LA MERCI S.A - Pharma', 105, 20, null, null, 'center');
                doc.setFontSize(10);
                doc.text('Adresse : 5, Rue Rivière en face du Rectorat de l\'UEH', 105, 30, null, null, 'center');
                doc.text('Email: pharmachndlm@gmail.com', 105, 35, null, null, 'center');
                doc.text('Téléphone: +509 2910-3131', 105, 40, null, null, 'center');

                doc.setLineWidth(0.5);
                doc.line(10, 45, 200, 45);

                doc.setFontSize(16);
                doc.text('Rapport de Ventes - CHNDLM S.A - Pharma', 105, 55, { align: 'center' });

                doc.setFontSize(12);
                doc.text(`Date: ${new Date().toLocaleString()}`, 105, 65, { align: 'center' });

                const startDate = startDateInput.value ? new Date(startDateInput.value).toLocaleDateString() : 'Non spécifiée';
                const endDate = endDateInput.value ? new Date(endDateInput.value).toLocaleDateString() : 'Non spécifiée';
                const filter = salesFilter.options[salesFilter.selectedIndex].text;

                doc.text(`Période: ${startDate} - ${endDate}`, 105, 75, { align: 'center' });
                doc.text(`Filtre: ${filter}`, 105, 85, { align: 'center' });

                doc.autoTable({
                    html: '#sales-report-table',
                    startY: 90,
                    theme: 'striped',
                    headStyles: { fillColor: [60, 141, 188] },
                });

                doc.save('rapport_de_ventes.pdf');
            };

            document.getElementById('filter-button').addEventListener('click', filterSales);
            document.getElementById('download-pdf').addEventListener('click', downloadPDF);

            // Initial render with all data
            renderTable(salesHistory);
        });
    </script>
</body>

</html>
