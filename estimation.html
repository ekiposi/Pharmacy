<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimation totale des stocks - CHNDLM S.A</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="css/dashstyle.css">
    <style>
     /* Updated UI Styling */

:root {
    --primary-color: #5A9B42;
    --secondary-color: #5C9949;
    --accent-color: #71C052;
    --hover-color: #7DB767;
    --text-color: #FDFEFA;
    --background-color: #f4f4f4;
    --header-btn-bg: #4CAF50;
    --logout-btn-bg: #f44336;
    --pdf-btn-bg: #2196F3;
    --table-shadow: rgba(0, 0, 0, 0.1);
}

body {
    font-family: 'Arial', sans-serif;
    margin: 0;
    padding: 20px;
    background-color: var(--background-color);
    color: #333;
}










.search-container {
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
}

.search-container input {
  
    border: 1px solid #ccc;
    border-radius: 6px;
    flex-grow: 1;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.search-container button {
   
    border: none;
    background-color: var(--primary-color);
    color: var(--text-color);
    cursor: pointer;
    transition: background-color 0.3s;
}

.search-container button:hover {
    background-color: var(--secondary-color);
}

table {
    width: 100%;
    border-collapse: collapse;
    background-color: #fff;
    box-shadow: 0 2px 5px var(--table-shadow);
    border-radius: 8px;
    overflow: hidden;
}

th, td {
    border: 1px solid #ddd;
    padding: 16px;
    text-align: left;
}

th {
    background-color: var(--secondary-color);
    color: var(--text-color);
    font-weight: bold;
}

tr:nth-child(even) {
    background-color: #f9f9f9;
}

#pdf-download {
    margin-bottom: 15px;
    background-color: var(--pdf-btn-bg);
    color: var(--text-color);
    text-decoration: none;
    cursor: pointer;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

#pdf-download:hover {
    background-color: #1976d2;
    box-shadow: 0 4px 6px var(--table-shadow);
}

.total-row {
    font-weight: bold;
    background-color: #f2f2f2;
}

/* Add responsiveness */
@media (max-width: 768px) {
    .header-buttons {
        flex-direction: column;
        gap: 10px;
    }
    .search-container {
        flex-direction: column;
    }
    th, td {
        padding: 12px;
    }
}

    </style>
</head>

<body>
    <header>
        <h1>Estimation totale des stocks - CHNDLM S.A - Pharma</h1>
        <div class="header-buttons">
            <a href="dashboard.html" id="sales-button" class="header-btn"> Tableau de bord</a>
            <a href="jesyon.html" id="sales-button" class="header-btn">Gestion des Ventes</a>
            <a href="estimation.html" id="sales-button" class="header-btn">Estimation totale des stocks</a>
            <a href="perime.html" id="sales-button" class="header-btn">Médicaments Périmés</a>
            <a href="notif.html" id="sales-button" class="header-btn">Quantités insuffisantes</a>
            <a href="report.html" id="sales-button" class="header-btn">Rapports de ventes</a>
            <a href="sales.html" id="sales-button" class="header-btn">Ventes</a>
            <a href="index.html" id="logout-button" class="logout-btn">Déconnexion</a>
        </div>
    </header> 

    <div class="search-container">
        <input type="text" id="search-bar" placeholder="Rechercher un médicament" style="border-radius: 90px;">
        <select id="category-filter">
            <option value="" style="border-radius: 90px;">Toutes les catégories</option>
        </select>
        <button id="pdf-download">Télécharger en PDF</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Nom du Médicament</th>
                <th>Quantité en Stock</th>
                <th>Prix Unitaire</th>
                <th>Valeur Totale en Stock</th>
            </tr>
        </thead>
        <tbody id="medication-list">
            <!-- Medications will be dynamically populated here -->
        </tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="3">Total des Valeurs en Stock:</td>
                <td id="total-stock-value">0 GDES</td>
            </tr>
        </tfoot>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const medicationList = document.getElementById('medication-list');
            const totalStockValueCell = document.getElementById('total-stock-value');
            const searchBar = document.getElementById('search-bar');
            const categoryFilter = document.getElementById('category-filter');
            const pdfDownloadBtn = document.getElementById('pdf-download');
            const formatCurrency = (value) => {
                return new Intl.NumberFormat('fr-FR', {
                    style: 'currency',
                    currency: 'HTG'
                }).format(value);
            };
            const loadMedications = () => {
                const storedMedications = JSON.parse(localStorage.getItem('medications') || '[]');
                const activeMedications = storedMedications.filter(med => !med.isExpired);
                const categories = [...new Set(activeMedications.map(med => med.category))];
                categoryFilter.innerHTML = `
                    <option value="">Toutes les catégories</option>
                    ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                `;

                return activeMedications;
            };
            const renderMedicationList = (medications) => {
                let totalStockValue = 0;
                const listHTML = medications.map(med => {
                    const stockValue = med.quantity * parseFloat(med.price);
                    totalStockValue += stockValue;

                    return `
                        <tr>
                            <td>${med.name}</td>
                            <td>${med.quantity}</td>
                            <td>${formatCurrency(parseFloat(med.price))}</td>
                            <td>${formatCurrency(stockValue)}</td>
                        </tr>
                    `;
                }).join('');

                medicationList.innerHTML = listHTML;
                totalStockValueCell.textContent = formatCurrency(totalStockValue);
            };
            const filterMedications = () => {
                const medications = loadMedications();
                const searchTerm = searchBar.value.toLowerCase();
                const categoryTerm = categoryFilter.value;

                const filteredMedications = medications.filter(med => 
                    med.name.toLowerCase().includes(searchTerm) &&
                    (!categoryTerm || med.category === categoryTerm)
                );

                renderMedicationList(filteredMedications);
            };
            const generatePDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(16);
                doc.text('CENTRE HOSPITALIER NOTRE DAME DE LA MERCI S.A - Pharma', 105, 20, null, null, 'center');
                doc.setFontSize(10);
                doc.text('Adresse : 5, Rue Rivière en face du Rectorat de l\'UEH', 105, 30, null, null, 'center');
                doc.text('Email: pharmachndlm@gmail.com', 105, 35, null, null, 'center');
                doc.text('Téléphone: +509 2910-3131', 105, 40, null, null, 'center');

                doc.setLineWidth(0.5);
                doc.line(10, 45, 200, 45);

                doc.setFontSize(12);
                doc.text('Estimation Totale des Stocks', 105, 55, null, null, 'center');
                doc.setFontSize(10);
                doc.text(`Date: ${new Date().toLocaleString()}`, 105, 65, null, null, 'center');

                const medications = loadMedications();
                const tableColumn = ["Nom", "Quantité", "Prix Unitaire", "Valeur Stock"];
                const tableRows = medications.map(med => [
                    med.name, 
                    med.quantity.toString(), 
                    formatCurrency(parseFloat(med.price)),
                    formatCurrency(med.quantity * parseFloat(med.price))
                ]);
                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 60,
                    theme: 'striped'
                });
                const totalValue = medications.reduce((sum, med) => sum + (med.quantity * parseFloat(med.price)), 0);
                doc.text(`Total des Valeurs en Stock: ${formatCurrency(totalValue)}`, 14, doc.autoTable.previous.finalY + 10);
                doc.save('estimation_stocks.pdf');
            };

            searchBar.addEventListener('input', filterMedications);
            categoryFilter.addEventListener('change', filterMedications);
            pdfDownloadBtn.addEventListener('click', generatePDF);
            const initialMedications = loadMedications();
            renderMedicationList(initialMedications);
        });
    </script>
</body>
</html>